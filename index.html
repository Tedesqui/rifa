<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Online</title>
    <style>
        :root { --primary-color: #009ee3; --dark-text: #333; --background-color: #f4f4f9; --highlight-color: #ffc107; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--background-color); color: var(--dark-text); margin: 0; padding: 0; box-sizing: border-box; }
        .container { background-color: #ffffff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; max-width: 600px; margin: 20px auto; }
        @media (max-width: 768px) { .container { margin: 0; border-radius: 0; min-height: 100vh; padding: 20px; max-width: none; box-sizing: border-box; } .options-container { grid-template-columns: 1fr; } }
        h1, h2 { color: var(--dark-text); }
        .prize-highlight {
            /* COR ALTERADA PARA VERDE */
            color: #27ae60; 
            font-size: 1.2em;
            display: inline-block;
            margin-top: 5px;
        }
        .options-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .option-card { border: 2px solid transparent; padding: 20px; border-radius: 10px; cursor: pointer; background-color: var(--primary-color); color: #ffffff; position: relative; transition: transform 0.2s; }
        .option-card:hover { transform: translateY(-5px); }
        .option-card h3 { font-size: 1.8em; margin-top: 0; }
        .option-card .price { font-size: 2.2em; font-weight: bold; margin: 10px 0; }
        .option-card.recommended { border-color: var(--highlight-color); animation: pulse-border 2s infinite; }
        .badge { position: absolute; top: -1px; right: -1px; background-color: var(--highlight-color); color: var(--dark-text); padding: 5px 15px; font-size: 0.8em; font-weight: bold; border-bottom-left-radius: 10px; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255,193,7,.7); } 70% { box-shadow: 0 0 0 10px rgba(255,193,7,0); } 100% { box-shadow: 0 0 0 0 rgba(255,193,7,0); } }
        .results-container { margin-top: 40px; padding: 20px; border: 2px dashed var(--primary-color); border-radius: 10px; }
        #countdown { font-size: 2.5em; font-weight: bold; margin: 10px 0; color: var(--primary-color); }
        .winner-number { font-size: 2em; font-weight: bold; color: #27ae60; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center; position: relative; max-height: 80vh; overflow-y: auto; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        #payment-status { margin-top: 15px; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #email-form-group { margin-bottom: 20px; }
        #email-form-group input { width: 100%; padding: 10px; box-sizing: border-box; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; }
        #email-form-group button { width: 100%; padding: 12px; margin-top: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; }
        .copy-button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; text-align: center; font-size: 16px; margin: 10px 2px; cursor: pointer; border-radius: 5px; }
        #copy-message { margin-top: 10px; color: green; font-weight: bold; display: none; }
        .my-numbers-button { background-color: #28a745; color: white; border: none; padding: 10px 20px; font-size: 1em; border-radius: 8px; cursor: pointer; margin-top: 20px; display: none; }
        .ticket-list { list-style-type: none; padding: 0; margin-top: 20px; }
        .ticket-item { background-color: #f4f4f9; border-left: 5px solid var(--primary-color); margin-bottom: 15px; padding: 15px; text-align: left; border-radius: 5px; }
        .ticket-item .date { font-size: 0.8em; color: #666; }
        .ticket-item .numbers { font-size: 1.4em; font-weight: bold; color: var(--primary-color); margin-top: 5px; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rifa Online Especial!</h1>
        <p><strong>Escolha uma op√ß√£o, pague com PIX e se acertar o n√∫mero sorteado receba <br> <span class="prize-highlight">100 VEZES o valor que recebeu!</span></strong></p>
        <div class="options-container">
            <div class="option-card" onclick="openPixModal(5.00)"><h3>1 N√∫mero</h3><div class="price">R$ 5,00</div></div>
            <div class="option-card" onclick="openPixModal(10.00)"><h3>3 N√∫meros</h3><div class="price">R$ 10,00</div></div>
            <div class="option-card recommended" onclick="openPixModal(20.00)"><div class="badge">Mais Popular</div><h3>7 N√∫meros</h3><div class="price">R$ 20,00</div></div>
            <div class="option-card" onclick="openPixModal(50.00)"><h3>20 N√∫meros</h3><div class="price">R$ 50,00</div></div>
        </div>
        <button class="my-numbers-button" id="show-my-numbers-btn" onclick="showMyNumbers()">Ver Meus N√∫meros</button>
    </div>
    <div class="container">
        <h2>üèÜ Sorteio Di√°rio üèÜ</h2>
        <div class="results-container">
            <p>O sorteio acontece todos os dias! Contagem regressiva para as <strong>20:00h</strong>:</p>
            <div id="countdown">--:--:--</div>
            <p>N√∫mero Vencedor de Hoje:</p>
            <div class="winner-number">Aguardando...</div>
        </div>
    </div>
    <div class="modal-overlay" id="pix-modal"></div>
    <div class="modal-overlay" id="my-numbers-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeMyNumbersModal()">&times;</span>
            <h2>Seus Bilhetes V√°lidos</h2>
            <div id="my-tickets-container">
                <ul class="ticket-list" id="ticket-list-ul"></ul>
            </div>
        </div>
    </div>

    <script>
        let paymentCheckInterval, currentAmount, currentEmail, currentPaymentId;
        let validTicketsFromServer = []; 

        function scheduleMidnightReload() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 5, 0); 
            const msUntilMidnight = tomorrow - now;
            setTimeout(() => {
                window.location.reload();
            }, msUntilMidnight);
        }

        window.onload = async () => {
            startDailyCountdown();
            updateWinnerNumber();
            setInterval(updateWinnerNumber, 30000);
            
            scheduleMidnightReload();
            
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                if (response.ok) {
                    validTicketsFromServer = data.validTickets || [];
                    if (validTicketsFromServer.length > 0) {
                        document.getElementById('show-my-numbers-btn').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error("Erro ao iniciar sess√£o:", error);
            }
        };
        
        function showMyNumbers() {
            const listElement = document.getElementById('ticket-list-ul');
            listElement.innerHTML = ''; 

            if (validTicketsFromServer.length === 0) {
                listElement.innerHTML = '<p>Voc√™ n√£o tem n√∫meros v√°lidos para o sorteio de hoje.</p>';
            } else {
                validTicketsFromServer.sort((a, b) => new Date(b.purchaseTimestamp) - new Date(a.purchaseTimestamp));
                
                validTicketsFromServer.forEach(ticket => {
                    const item = document.createElement('li');
                    item.className = 'ticket-item';
                    const purchaseDate = new Date(ticket.purchaseTimestamp);
                    const formattedDate = purchaseDate.toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    item.innerHTML = `
                        <div class="date">Comprado em: ${formattedDate}</div>
                        <div class="numbers">${ticket.numbers.join(' - ')}</div>
                    `;
                    listElement.appendChild(item);
                });
            }
            document.getElementById('my-numbers-modal').style.display = 'flex';
        }
        
        function getDrawDateForTicket(purchaseTimestamp) { const purchaseDate=new Date(purchaseTimestamp); const purchaseHour=purchaseDate.getHours(); if(purchaseHour<20){return purchaseDate.toISOString().split('T')[0];}else{const nextDay=new Date(purchaseDate); nextDay.setDate(purchaseDate.getDate()+1); return nextDay.toISOString().split('T')[0];}}
        function openPixModal(amount) { currentAmount = amount; if(!document.getElementById('pix-modal').innerHTML.trim()){document.getElementById('pix-modal').innerHTML = `<div class="modal-content"><span class="close-button" onclick="closePixModal()">&times;</span><div id="email-form-group"><h2>Insira seu E-mail</h2><p><strong>Entraremos em contato atrav√©s desse e-mail em caso de vit√≥ria.</strong></p><input type="email" id="user-email" placeholder="Seu e-mail aqui" required><button onclick="generatePix()">Continuar</button></div><div id="pix-payment-group" style="display: none;"><h2>Pague com PIX para participar</h2><img id="qr-code-image" src="" style="width:100%; max-width:250px;"><p><strong>PIX Copia e Cola:</strong></p><input type="text" id="pix-code" readonly style="width: 90%; padding: 10px; text-align: center;"><button class="copy-button" onclick="copyPixCode()">Copiar C√≥digo PIX</button><div id="copy-message" style="display: none;">C√≥digo copiado!</div><hr><div id="payment-status"><div class="loader"></div>Aguardando confirma√ß√£o...</div><p style="font-weight: bold;">N√£o feche esta janela.</p></div></div>`;} document.getElementById('pix-modal').style.display = 'flex'; document.getElementById('email-form-group').style.display = 'block'; document.getElementById('pix-payment-group').style.display = 'none'; const emailInput = document.getElementById('user-email'); if(emailInput) emailInput.value = ''; }
        async function generatePix() { const emailInput = document.getElementById('user-email'); currentEmail = emailInput.value; if (!currentEmail || !validateEmail(currentEmail)) { alert('Por favor, insira um e-mail v√°lido.'); return; } document.getElementById('email-form-group').style.display = 'none'; document.getElementById('pix-payment-group').style.display = 'block'; try { const response = await fetch('/api/create-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount: currentAmount, email: currentEmail }), }); const data = await response.json(); if (response.ok) { document.getElementById('qr-code-image').src = `data:image/png;base64,${data.qrCodeBase64}`; document.getElementById('pix-code').value = data.qr_code; currentPaymentId = data.payment_id; startPaymentCheck(currentPaymentId); } else { document.getElementById('payment-status').innerHTML = `<p style="color: red;">Erro: ${data.details || 'Tente novamente'}</p>`; } } catch (error) { document.getElementById('payment-status').innerHTML = `<p style="color: red;">Erro de comunica√ß√£o.</p>`; } }
        function validateEmail(email) { const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/; return re.test(String(email).toLowerCase()); }
        function startPaymentCheck(paymentId) { if (paymentCheckInterval) clearInterval(paymentCheckInterval); paymentCheckInterval = setInterval(async () => { try { const response = await fetch(`/api/consultar-rifa?id=${paymentId}`); const data = await response.json(); if (data.status === 'approved') { clearInterval(paymentCheckInterval); document.getElementById('payment-status').innerHTML = `<p style="color: green;">Aprovado! Redirecionando...</p>`; setTimeout(() => { window.location.href = `/success.html?ticketId=${data.ticketId}`; }, 2000); } } catch (error) { console.error("Erro na verifica√ß√£o..."); } }, 5000); }
        function closePixModal() { if (paymentCheckInterval) clearInterval(paymentCheckInterval); document.getElementById('pix-modal').style.display='none'; }
        function copyPixCode() { const el = document.getElementById('pix-code'); el.select(); navigator.clipboard.writeText(el.value).then(() => { const msg = document.getElementById('copy-message'); msg.style.display = 'block'; setTimeout(() => { msg.style.display = 'none'; }, 2000); }); }
        function closeMyNumbersModal() { document.getElementById('my-numbers-modal').style.display = 'none'; }
        async function updateWinnerNumber() { try { const response = await fetch('/api/get-winner'); const data = await response.json(); if (response.ok) document.querySelector('.winner-number').textContent = data.number; } catch (error) { console.error("Erro ao buscar n√∫mero."); } }
        function startDailyCountdown() { const el = document.getElementById('countdown'); if (!el) return; setInterval(() => { const now = new Date(); let target = new Date(now); target.setHours(20, 0, 0, 0); if (now > target) target.setDate(target.getDate() + 1); const dist = target - now; const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60)); const s = Math.floor((dist % (1000 * 60)) / 1000); el.innerHTML = `${(h<10?'0':'')}${h}:${(m<10?'0':'')}${m}:${(s<10?'0':'')}${s}`; }, 1000); }
    </script>
</body>
</html>
